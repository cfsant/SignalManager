@inherits Grid<IqOptionAdminSignalDomain>

@this.Body
@this.LoadingSpinner

@code {
    public bool SelectedAll
    {
        get;
        set;
    }

    [Parameter]
    public Action OnEditCallback
    {
        get;
        set;
    }

    [Parameter]
    public Action OnRemoveCallback
    {
        get;
        set;
    }

    [Parameter]
    public UserDomain User
    {
        get;
        set;
    }

    protected override Task OnInitializedAsync()
    {
        this.Class = "d-flex flex-row w-100 align-self-center mt-xl-2 mt-lg-2 p-2";

        return Task.Run(async () => {
            await this.DataBag.ExecuteAsync(this.SignalOnInitializeAsync());
            this.SignalInitialization();

            this.Body = this.RenderBody();
        });
    }

    private void SignalOnInitializeAsyncEvent(bool value)
    {
        try
        {
            this.LoadingSpinner = @<Spinner PVisible="!value"/>;
        }
        finally
        {
            this.StateHasChanged();
        }
    }

    private RenderFragment LoadingSpinner
    {
        get;
        set;
    }

    private bool _booSignalOnInitializeAsync;

    private bool booSignalsOnInitializeAsync
    {
        get
        {
            return _booSignalOnInitializeAsync;
        }
        set
        {
            try
            {
                _booSignalOnInitializeAsync = value;
            }
            finally
            {
                this.SignalOnInitializeAsyncEvent(value);
            }
        }
    }

    public override Collection<RenderFragment> GetBase()
    {
        Base BaseContainer = new Base();
        BaseContainer.Parent = this;
        BaseContainer.Class = "flex-column w-100 m-xl-1 m-lg-1 fnt-default-size-xl fnt-default-size-lg fnt-default-size-md fnt-default-size-sm";
        BaseContainer.Content = new Collection<RenderFragment>();
        BaseContainer.Content.Add(this.GetHeader(BaseContainer));

        if (this.Data == null || this.Data.Count < 1)
        {
            return new Collection<RenderFragment>() { BaseContainer.RenderBody() };
        }

        foreach (RenderFragment child in this.GetBody(BaseContainer))
        {
            BaseContainer.Content.Add(child);
        }

        return new Collection<RenderFragment>() { BaseContainer.RenderBody() };
    }

    public override RenderFragment GetHeader(Base Parent)
    {
        Base HeaderContainer = new Base();
        HeaderContainer.Parent = Parent;
        HeaderContainer.Class = "d-flex flex-column bg-dark text-white rounded w-100 p-2";
        HeaderContainer.Style = "min-height:44px";
        HeaderContainer.Content = new Collection<RenderFragment>();

        Base HeaderCardContainer = new Base();
        HeaderCardContainer.Parent = Parent;
        HeaderCardContainer.Class = "d-inline-flex d-xl-none d-lg-none d-md-inline-flex d-sm-inline-flex w-100 justify-content-center text-center";
        HeaderCardContainer.Content = new Collection<RenderFragment>() {
            new B() { Parent = HeaderContainer, Text="Sinais" }.RenderBody()
        };

        Base HeaderSubContainer = new Base();
        HeaderSubContainer.Parent = Parent;
        HeaderSubContainer.Class = "d-none d-xl-inline-flex d-lg-inline-flex d-md-none d-sm-none  rounded text-white bg-dark w-100";
        HeaderSubContainer.Content = new Collection<RenderFragment>();

        Base SelectedHOption = new Base();
        SelectedHOption.Parent = HeaderSubContainer;
        SelectedHOption.Class = "col-1 text-center";
        SelectedHOption.Content = new Collection<RenderFragment>();

        Base SelectedHOptionSubContainer = new Base();
        SelectedHOptionSubContainer.Parent = SelectedHOption;
        SelectedHOptionSubContainer.Class = "d-flex justify-content-center pl-4";
        SelectedHOptionSubContainer.Content = new Collection<RenderFragment>() {
            new Input<bool>() { Parent = SelectedHOptionSubContainer, Class="form-check-input", Type="checkbox", Value=this.SelectedAll }.RenderBody()
        };

        SelectedHOption.Content.Add(SelectedHOptionSubContainer.RenderBody());

        Base DateHOption = new Base();
        DateHOption.Parent = HeaderSubContainer;
        DateHOption.Class = "col-2";
        DateHOption.Content = new Collection<RenderFragment>() {
            new B() { Parent = DateHOption, Text="Data" }.RenderBody()
        };

        Base DurationHOption = new Base();
        DurationHOption.Parent = HeaderSubContainer;
        DurationHOption.Class = "col-1";
        DurationHOption.Content = new Collection<RenderFragment>() {
            new B() { Parent = DurationHOption, Text="Duração" }.RenderBody()
        };

        Base AmountHOption = new Base();
        AmountHOption.Parent = HeaderSubContainer;
        AmountHOption.Class = "col-2 text-center";
        AmountHOption.Content = new Collection<RenderFragment>() {
            new B() { Parent = AmountHOption, Text="Valor" }.RenderBody()
        };

        Base TagsHOption = new Base();
        TagsHOption.Parent = HeaderSubContainer;
        TagsHOption.Class = "col-5 text-center";
        TagsHOption.Content = new Collection<RenderFragment>() {
            new B() { Parent = TagsHOption, Text="Tags" }.RenderBody()
        };

        Base EditHOption = new Base();
        EditHOption.Parent = HeaderSubContainer;
        EditHOption.Class = "col-1";
        EditHOption.Content = new Collection<RenderFragment>() {
            new B() { Parent = HeaderContainer, Text="" }.RenderBody()
        };

        HeaderSubContainer.Content.Add(SelectedHOption.RenderBody());
        HeaderSubContainer.Content.Add(DateHOption.RenderBody());
        HeaderSubContainer.Content.Add(DurationHOption.RenderBody());
        HeaderSubContainer.Content.Add(AmountHOption.RenderBody());
        HeaderSubContainer.Content.Add(TagsHOption.RenderBody());
        HeaderSubContainer.Content.Add(EditHOption.RenderBody());

        HeaderContainer.Content.Add(HeaderCardContainer.RenderBody());
        HeaderContainer.Content.Add(HeaderSubContainer.RenderBody());

        return HeaderContainer.RenderBody();
    }

    public RenderFragment GetHeaderCards(Base Parent)
    {
        Base HeaderCardContainer = new Base();
        HeaderCardContainer.Parent = Parent;
        HeaderCardContainer.Class = "d-none d-xl-none d-lg-none d-md-inline-flex d-sm-inline-flex rounded text-white bg-dark w-100 p-2";
        HeaderCardContainer.Content = new Collection<RenderFragment>() {
            new B() { Parent = HeaderCardContainer, Text="Sinais" }.RenderBody()
        };

        return HeaderCardContainer.RenderBody();
    }

    public override Collection<RenderFragment> GetBody(Base Parent)
    {

        Collection<RenderFragment> Rows = new Collection<RenderFragment>();
        if (this.Data == null || this.Data.Count < 1)
        {
            return Rows;
        }

        foreach (IqOptionAdminSignalDomain item in this.Data.OrderBy(x => x.Entry))
        {

            Signal model = new Signal();
            model = Utils.Parse<IqOptionAdminSignalDomain, Signal>(item, model);

            Base BodyContainer = new Base();
            BodyContainer.Parent = Parent;
            BodyContainer.Class = "d-inline-flex flex-row flex-wrap border-sm border-md border-lg tt-col-sm tt-col-md mt-2 w-100 min-sm-h-180";
            BodyContainer.Style = "border-radius:15px;";
            BodyContainer.Content = new Collection<RenderFragment>();

            Base SelectedHOptionContainer = new Base();
            SelectedHOptionContainer.Parent = BodyContainer;
            SelectedHOptionContainer.Class = "d-xl-block d-lg-block d-md-none d-sm-none col-xl-1 col-lg-1 col-md-12 col-sm-12 pr-0 pt-1";
            SelectedHOptionContainer.Content = new Collection<RenderFragment>();

            Base SelectedHOptionSubContainer = new Base();
            SelectedHOptionSubContainer.Parent = SelectedHOptionContainer;
            SelectedHOptionSubContainer.Class = "d-flex justify-content-center pl-4";
            SelectedHOptionSubContainer.Content = new Collection<RenderFragment>() {
                new Input<bool>() { Parent = SelectedHOptionSubContainer, Class="form-check-input", Type="checkbox", Value=model.Selected }.RenderBody()
            };

            SelectedHOptionContainer.Content.Add(SelectedHOptionSubContainer.RenderBody());

            Base DateHOptionContainer = new Base();
            DateHOptionContainer.Parent = BodyContainer;
            DateHOptionContainer.Class = "col-xl-2 col-lg-2 col-md-6 col-sm-6 pt-xl-1 pt-lg-1";
            DateHOptionContainer.Content = new Collection<RenderFragment>() {
                new Text() { Parent = DateHOptionContainer, Content = model.Entry.ToString("dd/MM/yyyy HH:mm:ss") }.RenderBody()
            };

            RenderFragment DataHOptionLabel = @<Label For="@DateHOptionContainer.Uid" Class="d-block d-xl-none d-lg-none d-md-block d-sm-block col-md-6 col-sm-6 align-self-center" Text="Data:" Bold="true" Style="max-height:18px"/>;

            Base DurationHOptionContainer = new Base();
            DurationHOptionContainer.Parent = BodyContainer;
            DurationHOptionContainer.Class = "col-xl-1 col-lg-1 col-md-3 col-sm-3 pt-xl-1 pt-lg-1 pl-xl-4 pl-lg-2";
            DurationHOptionContainer.Content = new Collection<RenderFragment>() {
                new Text() { Parent = DurationHOptionContainer, Content = model.Exp.ToString(), Class="text-right text-xl-left text-lg-center" }.RenderBody()
            };

            RenderFragment DurationHOptionLabel = @<Label For="@DurationHOptionContainer.Uid" Class="d-block d-xl-none d-lg-none d-md-block d-sm-block col-md-3 col-sm-3 align-self-center" Text="Duração:" Bold="true" Style="max-height:18px"/>;

            Base AmountHOptionContainer = new Base();
            AmountHOptionContainer.Parent = BodyContainer;
            AmountHOptionContainer.Class = "col-xl-2 col-lg-2 col-md-3 col-sm-3 pt-xl-1 pt-lg-1 text-xl-center";
            AmountHOptionContainer.Content = new Collection<RenderFragment>() {
                new Text() { Parent = AmountHOptionContainer, Content=model.Amount.ToString("N2"), Class="text-right text-xl-center text-lg-center" }.RenderBody()
            };

            RenderFragment AmountHOptionLabel = @<Label For="@AmountHOptionContainer.Uid" Class="d-block d-xl-none d-lg-none d-md-block d-sm-block col-md-3 col-sm-3 align-self-center text-right" Text="Valor:" Bold="true" Style="max-height:18px"/>;

            Base CardFirstRowHOptionContainer = new Base();
            CardFirstRowHOptionContainer.Parent = BodyContainer;
            CardFirstRowHOptionContainer.Class = "d-inline-flex d-xl-none d-lg-none d-md-inline-flex d-sm-inline-flex w-100";
            CardFirstRowHOptionContainer.Content = new Collection<RenderFragment>();
            CardFirstRowHOptionContainer.Content.Add(DataHOptionLabel);
            CardFirstRowHOptionContainer.Content.Add(DurationHOptionLabel);
            CardFirstRowHOptionContainer.Content.Add(AmountHOptionLabel);

            Base TagsHOptionContainer = new Base();
            TagsHOptionContainer.Parent = BodyContainer;
            TagsHOptionContainer.Class = "col-xl-5 col-lg54 col-md-10 col-sm-10 pt-xl-1 pt-lg-1 text-xl-center text-lg-center";
            TagsHOptionContainer.Content = new Collection<RenderFragment>();

            TagsHOptionContainer.Content.Add(@<MatChip Label="@(Enum.GetName(typeof(ActivePair), model.ActivePair))" Class="bg-info text-white"/>);
            TagsHOptionContainer.Content.Add(@<MatChip Label="@(Enum.GetName(typeof(OrderDirection), model.OrderDirection))" Class=@(((OrderDirection)model.OrderDirection) == OrderDirection.Put ? "bg-success text-white" : "bg-danger text-white") />);

            if (model.MartinGaleCount > 0)
            {
                TagsHOptionContainer.Content.Add(@<MatChip Label="@string.Format("{0}x — R${1}", model.MartinGaleCount, model.MartinGale.ToString("N2"))" Class="bg-primary text-white"/>);
            }

            RenderFragment TagsHOptionLabel = @<Label For="@TagsHOptionContainer.Uid" Class="d-block d-xl-none d-lg-none d-md-block d-sm-block col-md-2 col-sm-2 align-self-top pt-1" Text="Tags:" Bold="true" Style="max-height:18px"/>;

            // CARD-VIEW
            Base HOptionCard = new Base();
            HOptionCard.Parent = BodyContainer;
            HOptionCard.Class = "d-inline-flex d-xl-none d-lg-none d-md-inline-flex d-sm-inline-flex pt-1 pl-3 pr-3 w-100 bg-dark text-white";
            HOptionCard.Style = "border-bottom-right-radius:15px; border-bottom-left-radius:15px;";
            HOptionCard.Content = new Collection<RenderFragment>();

            Base EditHOptionCardContainer = new Base();
            EditHOptionCardContainer.Parent = HOptionCard;
            EditHOptionCardContainer.Class = "d-flex w-50 text-center";
            EditHOptionCardContainer.Content = new Collection<RenderFragment>() {
                this.GetEditControl(model, false)
            };

            Base RemoveHOptionCardContainer = new Base();
            RemoveHOptionCardContainer.Parent = HOptionCard;
            RemoveHOptionCardContainer.Class = "d-flex w-50 text-center";
            RemoveHOptionCardContainer.Content = new Collection<RenderFragment>() {
                this.GetRemoveControl(model, false)
            };

            HOptionCard.Content.Add(EditHOptionCardContainer.RenderBody());
            HOptionCard.Content.Add(RemoveHOptionCardContainer.RenderBody());

            // TABLE-VIEW
            Base EditHOptionContainer = new Base();
            EditHOptionContainer.Parent = BodyContainer;
            EditHOptionContainer.Class = "d-xl-block d-lg-block d-md-none d-sm-none text-center p-0 m-0";
            EditHOptionContainer.Content = new Collection<RenderFragment>() {
                this.GetEditControl(model, true)
            };

            Base RemoveHOptionContainer = new Base();
            RemoveHOptionContainer.Parent = BodyContainer;
            RemoveHOptionContainer.Class = "d-xl-block d-lg-block d-md-none d-sm-none d-xs-none text-center p-0 m-0";
            RemoveHOptionContainer.Content = new Collection<RenderFragment>() {
                this.GetRemoveControl(model, true)
            };

            // CARD-VIEW 
            // HIDDEN
            BodyContainer.Content.Add(SelectedHOptionContainer.RenderBody());

            // FIRST ROW 
            BodyContainer.Content.Add(CardFirstRowHOptionContainer.RenderBody());

            BodyContainer.Content.Add(DateHOptionContainer.RenderBody());
            BodyContainer.Content.Add(DurationHOptionContainer.RenderBody());
            BodyContainer.Content.Add(AmountHOptionContainer.RenderBody());

            // SECOND ROW
            BodyContainer.Content.Add(TagsHOptionLabel);

            BodyContainer.Content.Add(TagsHOptionContainer.RenderBody());

            // THIRD ROW

            // CONTROL'S
            BodyContainer.Content.Add(HOptionCard.RenderBody());

            Base ControlsContainer = new Base();
            ControlsContainer.Parent = BodyContainer;
            ControlsContainer.Class = "col-1 d-inline-flex justify-content-end";
            ControlsContainer.Content = new Collection<RenderFragment>();
            ControlsContainer.Content.Add(EditHOptionContainer.RenderBody());
            ControlsContainer.Content.Add(RemoveHOptionContainer.RenderBody());

            BodyContainer.Content.Add(ControlsContainer.RenderBody());

            // MODAL
            BodyContainer.Content.Add(this.GetModal(BodyContainer, model));

            //Rows.Add(BodyContainer.RenderBody());
            Rows.Add(@<GrdSignalRow Parent="Parent" Model="model" OnEdit="OnEdit" OnRemove="OnRemove" OnModelUpdate="OnModelUpdate" OnModalCancelation="OnModalCancelation" />);
        }

        return Rows;
    }

    private RenderFragment GetRow(Base Parent, Signal model)
    {
        Row<Signal> row = new Row<Signal>();
        row.Parent = Parent;
        row.Class = "d-inline-flex flex-row flex-wrap border-sm border-md border-lg tt-col-sm tt-col-md mt-2 w-100 min-sm-h-180";
        row.Style = "border-radius:15px;";
        row.Content = new Collection<RenderFragment>();

        return row.RenderBody();
    }


    private RenderFragment GetModal(Base Parent, Signal model)
    {
        return @<MatDialog @bind-IsOpen="@model.Editing">
                    @if (model.Editing)
                    {
                        <SignalModal Parent="Parent" Model="model" OnModelUpdateCallback=@(new Action<Signal>((m) => OnModelUpdate(m))) OnCancelationCallback=@(new Action<Signal>((m) => OnModalCancelation(m)))/>
                    }
                </MatDialog>;
    }

    private RenderFragment GetEditControl(Signal model, bool Link = false)
    {
        if (Link)
        {
            return @<MatIconButton Icon="@MatIconNames.Edit" OnClick=@(new Action(() => OnEdit(model))) />;
        }

        return @<Button Class="btn btn-dark w-100" OnClick=@(new Action(() => OnEdit(model))) Text="Editar"/>;
    }

    private RenderFragment GetRemoveControl(Signal model, bool Link = false)
    {
        if (Link)
        {
            return @<MatIconButton Icon="@MatIconNames.Delete" OnClick=@(new Action(() => OnRemove(model)))/>;
        }

        return @<Button Class="btn btn-dark w-100" OnClick=@(new Action(() => OnRemove(model))) Text="Remover"/>;
    }

    private void OnEdit(Signal model)
    {
        model.Editing = true;

        this.OnEditCallback?.Invoke();
    }

    private void OnRemove(Signal model)
    {
        this.Data.Remove(model);

        this.OnRemoveCallback?.Invoke();
    }

    private void OnModelUpdate(Signal model)
    {
        this.Data.Update(model, model.Uuid.ToString());

        this.ReRenderBody();
    }

    private void OnModalCancelation(Signal model)
    {
        this.ReRenderBody();
    }

    private void SignalInitialization()
    {
        while (!this.booSignalsOnInitializeAsync)
        {
            System.Threading.Thread.Sleep(10);
        }

        Console.WriteLine("Inicialização dos sinais do administrador (page)...");

        List<IqOptionAdminSignalDomain> lstSignal = this.DataBag.Get("sigmgmt_signals_adm") as List<IqOptionAdminSignalDomain>;
        if (lstSignal == null || lstSignal.Count < 1)
        {
            this.Data = new DataController<IqOptionAdminSignalDomain>();

            return;
        }

        Console.WriteLine("Sinais do adiminstrador carregados com sucesso.");

        this.Data.AddRange(lstSignal);
    }

    private async Task SignalOnInitializeAsync()
    {
        Console.WriteLine("Inicialização dos sinais do administrador (base)...");

        this.booSignalsOnInitializeAsync = false;

        try
        {
            if (this.User == null || string.IsNullOrEmpty(this.User.Uuid.ToString()) || string.IsNullOrWhiteSpace(this.User.Uuid.ToString()))
            {
                Console.WriteLine("Skipped.");

                return;
            }

            var lstSignal = await this.PostWithTokenAsync<IqOptionAdminSignalDomain>("Signal/FetchAllAsync", new IqOptionAdminSignalDomain() { UuidUser = this.User.Uuid }, true);
            if (lstSignal == null && lstSignal.Count < 1)
            {

                Console.WriteLine("Sem sinais do administrador..");

                return;
            }

            this.DataBag.Set(new Bag("sigmgmt_signals_adm", lstSignal));
            Console.WriteLine("Sinais do administrador recuperados com sucesso.");
        }
        finally
        {
            this.booSignalsOnInitializeAsync = true;
        }
    }
}
